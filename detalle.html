<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle Cámara - Tráfico GC</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="css/style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { overflow-x: hidden; background-color: #1a1a2e; }
        .video-card { border: 1px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.5); background-color: #000; overflow: hidden; }
        .stats-card { height: 100%; border-left: 1px solid #333; background: #16213e; }
        .fade-change { transition: color 0.5s ease; }
        
        .ad-container-detail {
            margin-bottom: 20px;
            text-align: center;
        }
        
        @media (min-width: 1400px) { .container-fluid { padding-left: 30px; padding-right: 30px; } }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark border-bottom border-secondary mb-3">
        <div class="container-fluid">
            <a class="btn btn-outline-light btn-sm" href="index.html">
                <i class="fas fa-arrow-left"></i> Volver al Mapa
            </a>
            <span class="navbar-text text-light mx-auto fw-bold text-uppercase" id="cameraTitle" style="font-size: 1.2rem;">
                Cargando...
            </span>
            <div style="width: 100px;"></div> 
        </div>
    </nav>

    <div class="container-fluid px-3">
        
        <div class="row ad-container-detail">
            <div class="col-12">
                <div class="text-center">
                    <div class="ad-label" style="color: #ccc; font-size: 0.8rem; margin-bottom: 5px;">Publicidad</div>
                    <div class="ad-banner">
                        <a href="https://www.amazon.es/neumaticos-coche/b?ie=UTF8&node=2424920031" target="_blank" rel="nofollow sponsored">
                            <img src="https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?q=80&w=800&auto=format&fit=crop" 
                                 alt="Oferta Neumáticos" 
                                 style="max-height: 120px; width: auto; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3">
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <button id="btnSubscribe" class="btn btn-outline-secondary" disabled>
                        <i class="fas fa-spinner fa-spin"></i> Cargando...
                    </button>
                </div>
                <div id="vip-badge" class="d-none">
                    <span class="badge bg-warning text-dark"><i class="fas fa-crown"></i> USUARIO VIP</span>
                </div>
            </div>

            <div class="col-lg-9 col-xl-10">
                <div class="card video-card text-light">
                    <div class="card-body p-0">
                        <div id="videoContainer" class="ratio ratio-16x9">
                            <div class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                <span>Cargando señal de vídeo...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-xl-2">
                <div class="card stats-card text-light border-secondary">
                    <div class="card-header border-secondary bg-opacity-10 bg-info">
                        <h6 class="mb-0 text-center"><i class="fas fa-satellite-dish text-success"></i> ThingSpeak Live</h6>
                    </div>
                    <div class="card-body d-flex flex-column gap-3">
                        
                        <div class="alert alert-dark border-secondary text-center m-0">
                            <small class="text-muted d-block mb-1">Nivel Actual</small>
                            <h1 class="display-4 fw-bold mb-0 fade-change" id="currentLevelDisplay">--</h1>
                            <small class="text-secondary">Escala 0-10</small>
                        </div>

                        <div id="status-badge" class="text-center">
                            <span class="badge bg-secondary p-2 w-100 fs-6">Conectando...</span>
                        </div>

                        <hr class="border-secondary m-0">

                        <div class="text-center">
                            <small class="text-muted" style="font-size: 10px;">ID Canal: <span id="ts-channel">--</span></small>
                        </div>

                        <div id="thingspeak-placeholder" class="flex-grow-1 d-flex flex-column">
                             <div style="flex-grow: 1; min-height: 180px; position: relative;">
                                <canvas id="trafficChart"></canvas>
                             </div>
                            <p class="text-center text-muted mt-2 mb-0" style="font-size: 0.75rem;">
                                Actualizado: <span id="lastUpdate">--:--:--</span>
                            </p>
                        </div>

                    </div>
                </div>
            </div>

        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="p-3 rounded" style="background-color: rgba(255,255,255,0.05);">
                    <h5><i class="fas fa-info-circle text-info"></i> Información del Tramo</h5>
                    <p class="text-secondary mb-0">Los datos se actualizan cada 15 segundos directamente desde los sensores IoT conectados a ThingSpeak.</p>
                </div>
            </div>
        </div>

    </div>

    <footer class="footer-custom">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 col-md-6 mb-4">
                    <h5 class="d-flex align-items-center">
                        <img src="images/Logo_Original.png" alt="Logo" style="height: 30px; margin-right: 10px;">
                        GrancaCam
                    </h5>
                    <p class="small">Monitorización de tráfico en tiempo real en Gran Canaria mediante cámaras DGT y sensores IoT.</p>
                    <div class="mt-3">
                        <a href="#" class="text-light me-3"><i class="fab fa-github fa-lg"></i></a>
                        <a href="#" class="text-light me-3"><i class="fab fa-twitter fa-lg"></i></a>
                        <a href="#" class="text-light"><i class="fab fa-instagram fa-lg"></i></a>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <h5>Enlaces Legales</h5>
                    <ul class="footer-links">
                        <li>
                            <a href="index.html">
                                <i class="fas fa-chevron-right text-muted me-2" style="font-size: 0.7rem;"></i> Inicio
                            </a>
                        </li>
                        <li>
                            <a href="aviso-legal.html">
                                <i class="fas fa-chevron-right text-muted me-2" style="font-size: 0.7rem;"></i> Aviso Legal
                            </a>
                        </li>
                        <li>
                            <a href="aviso-legal.html">
                                <i class="fas fa-chevron-right text-muted me-2" style="font-size: 0.7rem;"></i> Privacidad y Cookies
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="col-lg-4 col-md-12 mb-4">
                    <h5>Contacto</h5>
                    <p class="small mb-2"><i class="fas fa-map-marker-alt text-danger me-2"></i> Gran Canaria, España</p>
                    <p class="small mb-2"><i class="fas fa-envelope text-danger me-2"></i> <a href="mailto:angel.rivero104@alu.ulpgc.es">angel.rivero104@alu.ulpgc.es</a></p>
                    <p class="small mb-2"><i class="fas fa-envelope text-danger me-2"></i> <a href="mailto:isaac.vera102@alu.ulpgc.es">isaac.vera102@alu.ulpgc.es</a></p>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="row">
                    <div class="col-md-6 text-md-start">&copy; 2025 GrancaCam. Todos los derechos reservados.</div>
                    <div class="col-md-6 text-md-end mt-2 mt-md-0"><span class="text-muted">Desarrollado por A. Rivero & I. Vera</span></div>
                </div>
            </div>
        </div>
    </footer>
    
    <div class="modal fade" id="vipModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-warning"><i class="fas fa-crown"></i> Hazte Premium</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p>Funcionalidad Premium (Aquí iría tu integración de Paypal)</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=EUR"></script>
    
    <script src="js/main.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // ============================================
            // 1. CONFIGURACIÓN DE LA GRÁFICA Y CÁMARAS
            // ============================================
            let myChart = null; 

            // Simulación de activación del botón (Por si main.js tarda en cargar o falla)
            // Si main.js funciona correctamente, sobrescribirá esto.
            const btnSubscribe = document.getElementById('btnSubscribe');
            if(btnSubscribe) {
                setTimeout(() => {
                    // Solo lo activamos si sigue diciendo "Cargando..."
                    if(btnSubscribe.innerText.includes("Cargando")) {
                        btnSubscribe.disabled = false;
                        btnSubscribe.innerHTML = '<i class="fas fa-bell"></i> Suscribirse a Alertas';
                        btnSubscribe.classList.remove('btn-outline-secondary');
                        btnSubscribe.classList.add('btn-outline-danger');
                        
                        // Evento simple por si no hay main.js
                        btnSubscribe.addEventListener('click', () => {
                            alert("Para que este botón funcione, asegúrate de que 'js/main.js' está bien configurado con Supabase.");
                        });
                    }
                }, 2000);
            }

            const detailCameras = [
                { id: 1, name: "GC1 Telde", videoId: "KmcLujr7PU0", tsChannel: "000000", tsField: "1" },
                { id: 2, name: "GC1 Jinamar", videoId: "2vDowXZy9cc", tsChannel: "000000", tsField: "1" },
                { id: 3, name: "GC2 Arucas", videoId: "z1E5ciDe3a0", tsChannel: "000000", tsField: "1" },
                { id: 4, name: "GC2 Bañaderos", videoId: "XGzncIaJJ44", tsChannel: "000000", tsField: "1" },
                { id: 5, name: "Mesa y López", videoId: "gfsJIcCZzlI", tsChannel: "000000", tsField: "1" },
                { 
                    id: 6, 
                    name: "La Ballena", 
                    videoId: "ZVgz2e-wMR4", 
                    tsChannel: "3199441", 
                    tsField: "1",
                    readKey: "Q1XCOL5COQL3D5QB" 
                },
                { id: 7, name: "Siete Palmas", videoId: "eMbMc7VnI5Q", tsChannel: "000000", tsField: "1" },
                { id: 8, name: "Maspalomas Sur", videoId: "xrYXDI5uAoA", tsChannel: "000000", tsField: "1" }
            ];

            const urlParams = new URLSearchParams(window.location.search);
            // Usamos ID 6 (La Ballena) por defecto si no hay ID en la URL para probar
            const camId = parseInt(urlParams.get('id')) || 6; 
            
            const camera = detailCameras.find(c => c.id === camId);

            if (camera) {
                // Títulos
                document.title = `${camera.name} | Live`;
                const titleEl = document.getElementById('cameraTitle');
                if(titleEl) titleEl.innerText = camera.name;
                
                const tsEl = document.getElementById('ts-channel');
                if(tsEl) tsEl.innerText = camera.tsChannel;

                // Video
                const videoContainer = document.getElementById('videoContainer');
                if(videoContainer) {
                    videoContainer.innerHTML = `
                        <iframe 
                            src="https://www.youtube-nocookie.com/embed/${camera.videoId}?autoplay=1&mute=1&rel=0&playsinline=1" 
                            title="Cámara Tráfico"
                            class="w-100 h-100"
                            style="border:0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen>
                        </iframe>
                    `;
                }

                // Iniciar Chart y ThingSpeak
                initChart();
                fetchThingSpeakData(camera);
                setInterval(() => fetchThingSpeakData(camera), 15000);

            } else {
                console.error("Cámara no encontrada");
            }

            // ============================================
            // 2. LÓGICA DE THINGSPEAK Y CHART.JS
            // ============================================
            async function fetchThingSpeakData(cam) {
                if(!cam || cam.tsChannel === "000000") {
                    updateUI(0);
                    return; 
                }

                try {
                    let url = `https://api.thingspeak.com/channels/${cam.tsChannel}/feeds.json?results=20`;
                    if (cam.readKey && cam.readKey !== "") {
                        url += `&api_key=${cam.readKey}`;
                    }

                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

                    const data = await response.json();
                    
                    const feeds = data.feeds;
                    if (feeds.length > 0) {
                        const lastFeed = feeds[feeds.length - 1];
                        const lastValue = lastFeed[`field${cam.tsField}`];
                        updateUI(parseInt(lastValue) || 0);
                        updateChartData(feeds, cam.tsField);
                    }

                } catch (error) {
                    console.error("Error conectando a ThingSpeak:", error);
                    const badge = document.getElementById('status-badge');
                    if(badge) badge.innerHTML = '<span class="badge bg-danger">Error Conexión</span>';
                }
            }

            function initChart() {
                const ctx = document.getElementById('trafficChart').getContext('2d');
                let gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(54, 162, 235, 0.5)');   
                gradient.addColorStop(1, 'rgba(54, 162, 235, 0)');

                myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Intensidad',
                            data: [],
                            borderColor: '#36a2eb',
                            backgroundColor: gradient,
                            borderWidth: 2,
                            pointBackgroundColor: '#ffffff',
                            pointRadius: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff'
                            }
                        },
                        scales: {
                            x: { display: false, grid: { display: false } },
                            y: {
                                beginAtZero: true,
                                max: 10, 
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#888', font: { size: 10 } }
                            }
                        },
                        interaction: { intersect: false },
                    }
                });
            }

            function updateChartData(feeds, fieldId) {
                if (!myChart) return;
                const labels = feeds.map(f => {
                    const date = new Date(f.created_at);
                    return date.getHours() + ':' + (date.getMinutes()<10?'0':'') + date.getMinutes();
                });
                const dataPoints = feeds.map(f => f[`field${fieldId}`]);

                myChart.data.labels = labels;
                myChart.data.datasets[0].data = dataPoints;
                
                const lastVal = parseFloat(dataPoints[dataPoints.length - 1]);
                if(lastVal >= 7) {
                    myChart.data.datasets[0].borderColor = '#dc3545';
                } else if(lastVal >= 3) {
                    myChart.data.datasets[0].borderColor = '#ffc107';
                } else {
                    myChart.data.datasets[0].borderColor = '#28a745';
                }
                myChart.update();
            }

            function updateUI(level) {
                const display = document.getElementById('currentLevelDisplay');
                const badgeContainer = document.getElementById('status-badge');
                const lastUpdate = document.getElementById('lastUpdate');
                
                if(display) display.innerText = level;
                if(lastUpdate) {
                    const now = new Date();
                    lastUpdate.innerText = now.toLocaleTimeString();
                }

                let badgeClass = '';
                let badgeText = '';
                let colorHex = '';

                if (level <= 2) {
                    badgeClass = 'badge bg-success p-2 w-100 fs-6';
                    badgeText = 'TRÁFICO FLUIDO';
                    colorHex = '#28a745'; 
                } else if (level <= 6) {
                    badgeClass = 'badge bg-warning text-dark p-2 w-100 fs-6';
                    badgeText = 'TRÁFICO DENSO';
                    colorHex = '#ffc107'; 
                } else {
                    badgeClass = 'badge bg-danger p-2 w-100 fs-6';
                    badgeText = 'RETENCIONES';
                    colorHex = '#dc3545'; 
                }

                if(badgeContainer) badgeContainer.innerHTML = `<span class="${badgeClass}">${badgeText}</span>`;
                if(display) display.style.color = colorHex;
            }
        });
    </script>
</body>
</html>